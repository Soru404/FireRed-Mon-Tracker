<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pokémon FireRed Tracker</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f0f0f5;
      margin: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    thead th {
      background-color: #4CAF50;
      color: #fff;
      padding: 12px;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    /* Player headers in black */
    thead th[contenteditable] {
      color: #000;
    }
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tbody tr:hover {
      background-color: #f1f1f1;
    }
    th, td {
      border: 1px solid #ddd;
      text-align: center;
      padding: 8px;
    }
    td:first-child {
      text-align: left;
      font-weight: 600;
      background-color: #fcfcfc;
      width: 200px;
    }
    th[contenteditable], td[contenteditable] {
      background: #eef;
      cursor: text;
    }
    .dropdown {
      position: absolute;
      background: white;
      border: 1px solid #aaa;
      max-height: 350px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 5px;
      min-width: 200px;
    }
    .dropdown input {
      width: 100%;
      padding: 4px;
      margin-bottom: 6px;
      box-sizing: border-box;
    }
    .dropdown-item {
      display: flex;
      align-items: center;
      padding: 4px;
      cursor: pointer;
    }
    .dropdown-item:hover {
      background: #eee;
    }
    .dropdown-item img {
      width: 32px;
      height: 32px;
      margin-right: 6px;
    }
    .selected-line {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 4px;
    }
    .selected-line img {
      width: 24px;
      height: 24px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pokémon FireRed Tracker</h1>
    <table id="tracker">
      <thead>
        <tr>
          <th>Location</th>
          <th>Name</th>
          <th contenteditable="true">Player 1</th>
          <th contenteditable="true">Player 2</th>
          <th contenteditable="true">Player 3</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    const stateFile = 'state.json';
    let allLines = [], availableLines = [];

    async function fetchJSON(file) {
      const res = await fetch(file);
      return res.ok ? res.json() : null;
    }

    async function loadState() {
      const state = await fetchJSON(stateFile);
      if (!state) return;
      // Restore player headers
      document.querySelectorAll('thead th[contenteditable]').forEach((th, i) => {
        if (state.players[i] != null) th.textContent = state.players[i];
      });
      // Restore rows
      const tbody = document.querySelector('#tracker tbody');
      state.rows.forEach((rowState, idx) => {
        const tr = tbody.children[idx];
        if (!tr) return;
        // Name cell
        tr.cells[1].textContent = rowState.name || '';
        // Selected evolution
        rowState.selections.forEach((sel, pIdx) => {
          if (sel) {
            const cell = tr.querySelector(`td[data-player="${pIdx+1}"]`);
            const wrapper = document.createElement('div');
            wrapper.className = 'selected-line';
            sel.forEach(poke => {
              const img = document.createElement('img');
              img.alt = poke.name;
              img.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${poke.id}.png`;
              wrapper.appendChild(img);
            });
            cell.innerHTML = '';
            cell.appendChild(wrapper);
            // Remove from availableLines
            availableLines = availableLines.filter(line => line.map(p=>p.name).join(',') !== sel.map(p=>p.name).join(','));
          }
        });
      });
    }

    async function saveState() {
      const players = Array.from(document.querySelectorAll('thead th[contenteditable]')).map(th => th.textContent.trim());
      const rows = Array.from(document.querySelectorAll('#tracker tbody tr')).map(tr => {
        const name = tr.cells[1].textContent.trim();
        const selections = [1,2,3].map(p => {
          const wrapper = tr.querySelector(`td[data-player="${p}"] .selected-line`);
          return wrapper
            ? Array.from(wrapper.querySelectorAll('img')).map(img => ({ name: img.alt, id: Number(img.src.match(/\/(\d+)\.png$/)[1]) }))
            : null;
        });
        return { name, selections };
      });
      const state = { players, rows };
      await fetch(stateFile, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(state)
      });
    }

    async function loadEvolutionLines() {
      const data = await fetchJSON('https://pokeapi.co/api/v2/evolution-chain?limit=10000');
      const chains = data.results.map(r => fetch(r.url).then(r=>r.json()));
      for (const chain of await Promise.all(chains)) {
        const line = [];
        (function traverse(node){
          const id = Number(node.species.url.match(/\/(\d+)\/$/)[1]);
          line.push({ name: node.species.name, id });
          if (node.evolves_to.length) traverse(node.evolves_to[0]);
        })(chain.chain);
        allLines.push(line);
      }
      availableLines = [...allLines];
    }

    function injectRows() {
      const locations = [
        "Pallet Town","Viridian City","Pewter City","Cerulean City","Vermilion City","Lavender Town","Celadon City","Fuchsia City","Saffron City","Cinnabar Island",
        "Route 1","Route 2","Route 3","Route 4","Route 5","Route 6","Route 7","Route 8","Route 9","Route 10","Route 11","Route 12","Route 13","Route 14","Route 15","Route 16","Route 17","Route 18","Route 19","Route 20","Route 21","Route 22","Route 23","Route 24","Route 25",
        "Mt. Moon","Diglett's Cave","Rock Tunnel","Seafoam Islands","Victory Road"
      ];
      const tbody = document.querySelector('#tracker tbody');
      locations.forEach(loc => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${loc}</td>
          <td contenteditable="true"></td>
          <td class="cell" data-player="1"></td>
          <td class="cell" data-player="2"></td>
          <td class="cell" data-player="3"></td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      injectRows();
      await loadEvolutionLines();
      await loadState();
      // Save on header or name edits
      document.querySelectorAll('thead th[contenteditable], td[contenteditable]').forEach(el =>
        el.addEventListener('input', saveState)
      );
      // Handle dropdown and selection
      document.addEventListener('click', e => {
        const cell = e.target.closest('.cell');
        if (cell) showDropdown(cell);
        else if (!e.target.closest('.dropdown')) closeDropdown();
      });
    });

    function showDropdown(cell) {
      closeDropdown();
      const rect = cell.getBoundingClientRect();
      const dd = document.createElement('div'); dd.className = 'dropdown';
      dd.style.top = rect.bottom + 'px'; dd.style.left = rect.left + 'px';
      const input = document.createElement('input'); input.placeholder = 'Search Pokémon...'; dd.appendChild(input);
      const list = document.createElement('div'); dd.appendChild(list);
      function render(filter='') {
        list.innerHTML = '';
        availableLines.forEach((line,i)=>{
          const text = line.map(p=>p.name).join(' → ').toLowerCase();
          if (!filter||text.includes(filter)){
            const item=document.createElement('div'); item.className='dropdown-item';
            line.forEach(p=>{const img=document.createElement('img');img.src=`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.id}.png`;img.alt=p.name;item.appendChild(img);});
            const span=document.createElement('span');span.textContent=line.map(p=>p.name).join(' → ');item.appendChild(span);
            item.onclick=async()=>{
              const wrapper=document.createElement('div');wrapper.className='selected-line';
              line.forEach(p=>{const img=document.createElement('img');img.src=`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.id}.png`;img.alt=p.name;wrapper.appendChild(img);});
              cell.innerHTML='';cell.appendChild(wrapper);
              availableLines.splice(i,1);
              await saveState();
              closeDropdown();
            };
            list.appendChild(item);
          }
        });
      }
      input.oninput=()=>render(input.value.trim().toLowerCase());
      render(); document.body.appendChild(dd);
    }

    function closeDropdown(){
      const e=document.querySelector('.dropdown'); if(e) e.remove();
    }
  </script>
</body>
</html>
